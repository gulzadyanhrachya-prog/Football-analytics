import streamlit as st
import pandas as pd
import numpy as np
from scipy.stats import poisson
from datetime import datetime, timedelta
import requests
import io
import urllib.parse

st.set_page_config(page_title="Betting Auto-Pilot v28 (Tank)", layout="wide")

# ==============================================================================\n# 1. ROBUSTN√ç NAƒå√çT√ÅN√ç DAT (S Fallbackem)\n# ==============================================================================\n\n@st.cache_data(ttl=3600)\ndef get_football_data_robust():\n    # URL adresy\n    url_direct = "http://api.clubelo.com/Fixtures"\n    url_proxy_1 = f"https://api.allorigins.win/get?url={urllib.parse.quote(url_direct)}"\n    url_proxy_2 = f"https://corsproxy.io/?{url_direct}"\n    \n    df = None\n    status = "Nenaƒçteno"\n\n    # 1. POKUS: Proxy AllOrigins\n    try:\n        r = requests.get(url_proxy_1, timeout=10)\n        data = r.json()\n        content = data.get("contents")\n        if content:\n            df = pd.read_csv(io.StringIO(content))\n            status = "‚úÖ AllOrigins Proxy"\n    except: pass\n\n    # 2. POKUS: Proxy CorsProxy (pokud 1. sel≈æe)\n    if df is None:\n        try:\n            r = requests.get(url_proxy_2, timeout=10)\n            if r.status_code == 200:\n                df = pd.read_csv(io.StringIO(r.text))\n                status = "‚úÖ CorsProxy"\n        except: pass\n\n    # 3. POKUS: P≈ô√≠mo (pokud proxy sel≈æou)\n    if df is None:\n        try:\n            df = pd.read_csv(url_direct)\n            status = "‚úÖ Direct Connection"\n        except: pass\n\n    # 4. POKUS: NOUZOV√ù RE≈ΩIM (Aby aplikace nespadla)\n    if df is None:\n        status = "‚ö†Ô∏è NOUZOV√ù RE≈ΩIM (Demo Data)"\n        # Vytvo≈ô√≠me fiktivn√≠ data, aby u≈æivatel vidƒõl alespo≈à UI\n        dnes = datetime.now()\n        data = {\n            "Date": [dnes.strftime("%Y-%m-%d"), (dnes+timedelta(days=1)).strftime("%Y-%m-%d")],\n            "Country": ["DEMO", "DEMO"],\n            "Home": ["Manchester City", "Real Madrid"],\n            "Away": ["Luton Town", "Barcelona"],\n            "EloHome": [2050, 1950],\n            "EloAway": [1600, 1940]\n        }\n        df = pd.DataFrame(data)\n\n    # Zpracov√°n√≠ data\n    try:\n        df['DateObj'] = pd.to_datetime(df['Date'])\n    except:\n        pass\n        \n    return df, status\n\n# ==============================================================================\n# 2. MATEMATICK√â MODELY\n# ==============================================================================\n\ndef calculate_probs(elo_h, elo_a):\n    # V√Ωhra (Elo)\n    elo_diff = elo_h - elo_a + 100 # Dom√°c√≠ v√Ωhoda\n    prob_h_win = 1 / (10**(-elo_diff/400) + 1)\n    prob_a_win = 1 - prob_h_win\n    \n    # Korekce na rem√≠zu\n    prob_draw = 0.25 \n    if abs(prob_h_win - 0.5) < 0.1: prob_draw = 0.30 \n    \n    real_h = prob_h_win * (1 - prob_draw)\n    real_a = prob_a_win * (1 - prob_draw)\n    \n    # G√≥ly (Poisson)\n    exp_xg_h = max(0.5, 1.45 + (elo_diff / 500))\n    exp_xg_a = max(0.5, 1.15 - (elo_diff / 500))\n    \n    max_g = 6\n    matrix = np.zeros((max_g, max_g))\n    for i in range(max_g):\n        for j in range(max_g):\n            matrix[i, j] = poisson.pmf(i, exp_xg_h) * poisson.pmf(j, exp_xg_a)\n            \n    prob_over_25 = 0\n    prob_btts = 0\n    for i in range(max_g):\n        for j in range(max_g):\n            if i + j > 2.5: prob_over_25 += matrix[i, j]\n            if i > 0 and j > 0: prob_btts += matrix[i, j]\n            \n    return {\n        "1": real_h, "0": prob_draw, "2": real_a,\n        "Over 2.5": prob_over_25, "Under 2.5": 1 - prob_over_25,\n        "BTTS Yes": prob_btts, "BTTS No": 1 - prob_btts\n    }\n\ndef pick_best_bet(probs):\n    candidates = [\n        ("V√Ωhra Dom√°c√≠ch (1)", probs["1"]),\n        ("V√Ωhra Host≈Ø (2)", probs["2"]),\n        ("Over 2.5 G√≥l≈Ø", probs["Over 2.5"]),\n        ("Under 2.5 G√≥l≈Ø", 1 - probs["Over 2.5"]),\n        ("Oba daj√≠ g√≥l (BTTS)", probs["BTTS Yes"])\n    ]\n    prob_10 = probs["1"] + probs["0"]\n    prob_02 = probs["2"] + probs["0"]\n    \n    candidates.sort(key=lambda x: x[1], reverse=True)\n    best_bet = candidates[0]\n    \n    if best_bet[1] < 0.55: \n        if prob_10 > prob_02: return "Neprohra Dom√°c√≠ch (10)", prob_10\n        else: return "Neprohra Host≈Ø (02)", prob_02\n            \n    return best_bet[0], best_bet[1]\n\n# ==============================================================================\n# 3. UI APLIKACE\n# ==============================================================================\n\nst.title("ü§ñ Betting Auto-Pilot (The Tank)")\n\n# --- FOTBAL ---\nst.header("‚öΩ Fotbal")\n\nwith st.spinner("Navazuji spojen√≠ se servery..."):\n    df_fix, status_msg = get_football_data_robust()\n\n# Zobrazen√≠ stavu p≈ôipojen√≠ (pro diagnostiku)\nif "NOUZOV√ù" in status_msg:\n    st.warning(f"Stav p≈ôipojen√≠: {status_msg}")\n    st.caption("Server ClubElo neodpov√≠d√°. Zobrazuji uk√°zkov√° data, aby aplikace bƒõ≈æela.")\nelse:\n    st.success(f"Stav p≈ôipojen√≠: {status_msg}")\n\nif df_fix is not None:\n    dnes = datetime.now().replace(hour=0, minute=0, second=0, microsecond=0)\n    limit = dnes + timedelta(days=4) \n    \n    # Filtr data\n    mask = (df_fix['DateObj'] >= dnes) & (df_fix['DateObj'] <= limit)\n    upcoming = df_fix[mask].copy()\n    \n    if upcoming.empty:\n        st.info("≈Ω√°dn√© z√°pasy v nejbli≈æ≈°√≠ch dnech (nebo konec sez√≥ny).")\n    else:\n        results = []\n        progress_bar = st.progress(0)\n        total_rows = len(upcoming)\n        \n        for i, (idx, row) in enumerate(upcoming.iterrows()):\n            if i % 10 == 0: progress_bar.progress(min(i / total_rows, 1.0))\n            \n            try:\n                home, away = row['Home'], row['Away']\n                elo_h = row.get('EloHome')\n                elo_a = row.get('EloAway')\n                \n                if pd.isna(elo_h) or pd.isna(elo_a): continue\n\n                probs = calculate_probs(elo_h, elo_a)\n                bet_name, confidence = pick_best_bet(probs)\n                fair_odd = 1 / confidence if confidence > 0 else 0\n                \n                results.append({\n                    "Datum": row['DateObj'].strftime("%d.%m. %H:%M"),\n                    "Soutƒõ≈æ": row.get('Country', 'EU'),\n                    "Z√°pas": f"{home} vs {away}",\n                    "DOPORUƒåEN√Å S√ÅZKA": bet_name,\n                    "D≈Øvƒõra": confidence * 100,\n                    "F√©rov√Ω kurz": fair_odd\n                })\n            except: continue\n        \n        progress_bar.empty()\n        \n        df_res = pd.DataFrame(results)\n        if not df_res.empty:\n            st.subheader("üî• TOP FOTBALOV√â TUTOVKY")\n            tutovky = df_res[df_res["D≈Øvƒõra"] >= 65].sort_values(by="D≈Øvƒõra", ascending=False)\n            if not tutovky.empty:\n                st.dataframe(tutovky.style.format({"D≈Øvƒõra": "{:.1f} %", "F√©rov√Ω kurz": "{:.2f}"}), hide_index=True, use_container_width=True)\n            else: st.info("≈Ω√°dn√© tutovky nad 65%.")\n            \n            st.subheader("üí° V≈†ECHNY TIPY (Se≈ôazeno)")\n            st.dataframe(df_res.sort_values(by="D≈Øvƒõra", ascending=False).style.format({"D≈Øvƒõra": "{:.1f} %", "F√©rov√Ω kurz": "{:.2f}"}), hide_index=True, use_container_width=True)\n        else: st.warning("Nepoda≈ôilo se vypoƒç√≠tat predikce.")\n\n# --- HOKEJ ---\nst.markdown("---")\nst.header("üèí NHL")\n\n@st.cache_data(ttl=3600)\ndef get_nhl_data():\n    try:\n        # Statistiky\n        r_stats = requests.get("https://api-web.nhle.com/v1/standings/now", timeout=10).json()\n        stats = {}\n        for t in r_stats['standings']:\n            stats[t['teamAbbrev']['default']] = {\n                "GF": t['goalFor']/t['gamesPlayed'],\n                "GA": t['goalAgainst']/t['gamesPlayed']\n            }\n        \n        # Rozpis\n        today = datetime.now().strftime("%Y-%m-%d")\n        r_sch = requests.get(f"https://api-web.nhle.com/v1/schedule/{today}", timeout=10).json()\n        \n        matches = []\n        avg_gf = 3.0\n        \n        for day in r_sch['gameWeek']:\n            for game in day['games']:\n                h = game['homeTeam']['abbrev']\n                a = game['awayTeam']['abbrev']\n                if h in stats and a in stats:\n                    xg_h = (stats[h]['GF'] * stats[a]['GA']) / avg_gf * 1.05\n                    xg_a = (stats[a]['GF'] * stats[h]['GA']) / avg_gf\n                    \n                    # Poisson Moneyline\n                    max_g = 10\n                    matrix = np.zeros((max_g, max_g))\n                    for i in range(max_g):\n                        for j in range(max_g):\n                            matrix[i, j] = poisson.pmf(i, xg_h) * poisson.pmf(j, xg_a)\n                    \n                    prob_h = np.sum(np.tril(matrix, -1)) + (np.sum(np.diag(matrix)) * 0.5)\n                    prob_a = np.sum(np.triu(matrix, 1)) + (np.sum(np.diag(matrix)) * 0.5)\n                    \n                    tip = f"V√Ωhra {h}" if prob_h > prob_a else f"V√Ωhra {a}"\n                    conf = max(prob_h, prob_a)\n                    \n                    matches.append({\n                        "Datum": day['date'],\n                        "Z√°pas": f"{h} vs {a}",\n                        "Tip": tip,\n                        "D≈Øvƒõra": conf * 100,\n                        "F√©rov√Ω kurz": 1/conf\n                    })\n        return matches\n    except: return []\n\nmatches = get_nhl_data()\nif matches:\n    df = pd.DataFrame(matches).sort_values(by="D≈Øvƒõra", ascending=False)\n    st.dataframe(df.style.format({"D≈Øvƒõra": "{:.1f} %", "F√©rov√Ω kurz": "{:.2f}"}), hide_index=True, use_container_width=True)\nelse:\n    st.warning("≈Ω√°dn√© z√°pasy NHL.")\n```

### Co teƒè uvid√≠≈°?
1.  **Zelen√° hl√°≈°ka:** "‚úÖ AllOrigins Proxy" nebo "‚úÖ CorsProxy" -> Znamen√° to, ≈æe se poda≈ôilo st√°hnout re√°ln√° data.
2.  **≈Ωlut√° hl√°≈°ka:** "‚ö†Ô∏è NOUZOV√ù RE≈ΩIM" -> Znamen√° to, ≈æe v≈°echna p≈ôipojen√≠ selhala, ale aplikace **nespadla**. Uvid√≠≈° tam 2 testovac√≠ z√°pasy (Man City, Real Madrid), abys vidƒõl, ≈æe logika funguje.
3.  **NHL:** Mƒõlo by fungovat norm√°lnƒõ (pokud se hraje).

Tohle je nejstabilnƒõj≈°√≠ verze, jakou m≈Ø≈æeme na free cloudu m√≠t.
